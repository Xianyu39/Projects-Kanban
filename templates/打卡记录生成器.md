<%*
// è·å–æœ¬å‘¨ä¸€æ—¥æœŸ
function getMondayDate() {
    const today = new Date();
    const day = today.getDay() - 7;
    const diff = today.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´å‘¨æ—¥çš„æƒ…å†µ
    const monday = new Date(today.setDate(diff));
    return monday.toISOString().split('T')[0]; // è¿”å› YYYY-MM-DD æ ¼å¼
}

const mondayDate = getMondayDate();

// æŸ¥æ‰¾åŒæ—¶åŒ…å«"æˆé•¿"å’Œ"è®¡åˆ’ä¹¦"æ ‡ç­¾çš„æ–‡ä»¶ï¼ˆæ”¯æŒå­æ ‡ç­¾ï¼‰
const files = app.vault.getMarkdownFiles();
const targetFiles = files.filter(file => {
    const cache = app.metadataCache.getFileCache(file);
    if (!cache?.frontmatter?.tags) return false;
    
    const tags = cache.frontmatter.tags;
    const hasGrowthTag = tags.some(tag => 
        typeof tag === 'string' && tag.includes('æˆé•¿')
    );
    const hasPlanTag = tags.some(tag => 
        typeof tag === 'string' && tag.includes('è®¡åˆ’ä¹¦')
    );
    
    return hasGrowthTag && hasPlanTag;
});

let output = `- ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleDateString()}
- æœ¬å‘¨æ‰“å¡æˆªæ­¢: ${mondayDate}

`;

// äº¤æ›¿æ’åˆ—ï¼šä»»åŠ¡1-å†…å®¹1-ä»»åŠ¡2-å†…å®¹2...
for (let file of targetFiles) {
    // 1. ç”Ÿæˆæ‰“å¡ä»»åŠ¡
    output += `## ğŸ“‹ ${file.basename}\n`;
    output += `- [ ] ${file.basename}çš„æ‰“å¡ä»»åŠ¡(@${mondayDate})\n`;
    
    // 2. æå–"å†…å®¹"ç« èŠ‚
    const content = await app.vault.read(file);
    const lines = content.split('\n');
    let inContentSection = false;
    let sectionContent = [];
    let foundContentSection = false;
    
    // æŸ¥æ‰¾"å†…å®¹"ç« èŠ‚ï¼ˆæ”¯æŒå¤šç§æ ‡é¢˜æ ¼å¼ï¼‰
    for (let line of lines) {
        // åŒ¹é…å„ç§å¯èƒ½çš„"å†…å®¹"æ ‡é¢˜æ ¼å¼
        if (line.match(/^#+\s*å†…å®¹/) || 
            line.match(/^#+\s*é¡¹ç›®å†…å®¹/) || 
            line.match(/^#+\s*è®¡åˆ’å†…å®¹/)) {
            inContentSection = true;
            foundContentSection = true;
            continue;
        }
        
        if (inContentSection) {
            // é‡åˆ°æ–°çš„åŒçº§æˆ–æ›´é«˜çº§æ ‡é¢˜æ—¶ç»“æŸ
            if (line.match(/^#{1,6}\s/) && !line.match(/^#+\s*å†…å®¹/)) {
                const currentLevel = (line.match(/^#+/)?.[0] || '').length;
                if (currentLevel <= 2) { // å‡è®¾"å†…å®¹"æ˜¯äºŒçº§æ ‡é¢˜
                    break;
                }
            }
            
            if (line.trim().length > 0) {
                sectionContent.push(line);
            }
        }
    }
    
    // 3. æ·»åŠ å†…å®¹è¯¦æƒ…
    output += `### ğŸ“– è¯¦æƒ…\n`;
    
    if (foundContentSection && sectionContent.length > 0) {
        output += sectionContent.join('\n') + '\n';
    } else {
        output += "*è¯¥é¡¹ç›®æš‚æ— è¯¦ç»†å†…å®¹æè¿°*\n\n";
    }
    
    output += "\n";
}

// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
if (targetFiles.length === 0) {
    output += "> â„¹ï¸ æœªæ‰¾åˆ°åŒæ—¶åŒ…å«'æˆé•¿'å’Œ'è®¡åˆ’ä¹¦'æ ‡ç­¾çš„æ–‡ä»¶ã€‚\n";
    output += "> è¯·ç¡®ä¿æ‚¨çš„é¡¹ç›®æ–‡ä»¶åŒ…å«ç±»ä¼¼æ ‡ç­¾ï¼š`tags: [æˆé•¿, è®¡åˆ’ä¹¦]`\n\n";
}

tR += output;
%>