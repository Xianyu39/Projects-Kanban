<%*
// 获取本周一日期
function getMondayDate() {
    const today = new Date();
    const day = today.getDay() - 7;
    const diff = today.getDate() - day + (day === 0 ? -6 : 1); // 调整周日的情况
    const monday = new Date(today.setDate(diff));
    return monday.toISOString().split('T')[0]; // 返回 YYYY-MM-DD 格式
}

const mondayDate = getMondayDate();

// 查找同时包含"成长"和"计划书"标签的文件（支持子标签）
const files = app.vault.getMarkdownFiles();
const targetFiles = files.filter(file => {
    const cache = app.metadataCache.getFileCache(file);
    if (!cache?.frontmatter?.tags) return false;
    
    const tags = cache.frontmatter.tags;
    const hasGrowthTag = tags.some(tag => 
        typeof tag === 'string' && tag.includes('成长')
    );
    const hasPlanTag = tags.some(tag => 
        typeof tag === 'string' && tag.includes('计划书')
    );
    
    return hasGrowthTag && hasPlanTag;
});

let output = `- 生成时间: ${new Date().toLocaleDateString()}
- 本周打卡截止: ${mondayDate}

`;

// 交替排列：任务1-内容1-任务2-内容2...
for (let file of targetFiles) {
    // 1. 生成打卡任务
    output += `## 📋 ${file.basename}\n`;
    output += `- [ ] ${file.basename}的打卡任务(@${mondayDate})\n`;
    
    // 2. 提取"内容"章节
    const content = await app.vault.read(file);
    const lines = content.split('\n');
    let inContentSection = false;
    let sectionContent = [];
    let foundContentSection = false;
    
    // 查找"内容"章节（支持多种标题格式）
    for (let line of lines) {
        // 匹配各种可能的"内容"标题格式
        if (line.match(/^#+\s*内容/) || 
            line.match(/^#+\s*项目内容/) || 
            line.match(/^#+\s*计划内容/)) {
            inContentSection = true;
            foundContentSection = true;
            continue;
        }
        
        if (inContentSection) {
            // 遇到新的同级或更高级标题时结束
            if (line.match(/^#{1,6}\s/) && !line.match(/^#+\s*内容/)) {
                const currentLevel = (line.match(/^#+/)?.[0] || '').length;
                if (currentLevel <= 2) { // 假设"内容"是二级标题
                    break;
                }
            }
            
            if (line.trim().length > 0) {
                sectionContent.push(line);
            }
        }
    }
    
    // 3. 添加内容详情
    output += `### 📖 详情\n`;
    
    if (foundContentSection && sectionContent.length > 0) {
        output += sectionContent.join('\n') + '\n';
    } else {
        output += "*该项目暂无详细内容描述*\n\n";
    }
    
    output += "\n";
}

// 如果没有找到符合条件的文件
if (targetFiles.length === 0) {
    output += "> ℹ️ 未找到同时包含'成长'和'计划书'标签的文件。\n";
    output += "> 请确保您的项目文件包含类似标签：`tags: [成长, 计划书]`\n\n";
}

tR += output;
%>